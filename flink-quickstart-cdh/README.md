# Flink Quickstart Application

The purpose of the Flink Quickstart Application is to have a working boilerplate code for a Flink application on top of CDH. The code demonstrates some basic capabilities of the DataStream API. It collects basic heap statistics of the JVM it's running on and dumps the collected data to the file system. It can also trigger alert messages when reaching concerning heap values.

## Usage

```
git clone https://github.infra.cloudera.com/morhidi/flink-ref.git
```
## Importing the project to IntelliJ
The quickstart application is based on the public Flink maven archetype. The project can be imported into IntelliJ by following the instructions from the public Flink documentation:
https://ci.apache.org/projects/flink/flink-docs-stable/dev/projectsetup/java_api_quickstart.html#maven

## Testing the project from IntelliJ

Simple run the class HeapMonitorPipeline from the IDE which should print one or multiple lines to the console (depending on the default parallelism):
```
...
13:50:54,524 INFO  com.cloudera.streaming.examples.flink.HeapMonitorSource       - starting HeapMonitorSource
13:50:54,524 INFO  com.cloudera.streaming.examples.flink.HeapMonitorSource       - starting HeapMonitorSource
13:50:54,524 INFO  com.cloudera.streaming.examples.flink.HeapMonitorSource       - starting HeapMonitorSource
13:50:54,524 INFO  com.cloudera.streaming.examples.flink.HeapMonitorSource       - starting HeapMonitorSource
...
```

The heap statistics are generated by a custom HeapMonitorSource class. All messages are simply saved to the file system, local or HDFS, depending on where the application runs. The output path is configurable with a program argument, e.g.:
```
--output /tmp/flinf-quickstart-cdh/stats
--output hdfs:///tmp/flinf-quickstart-cdh/stats
```


Under normal circumstances the logs are silent. The application triggers alert events only when the old gen space of the heap exceeds certain threshold values. The heap alerts are sent to a special sink called LogSink:

```
13:50:56,481 INFO  com.cloudera.streaming.examples.flink.LogSink                 - HeapAlert{message='Full GC expected soon', triggeringStats=HeapStats{area=PS Old Gen, used=65709552, max=5726797824, ratio=0.011474047804625276, jobId=3, hostname='morhidi-mbp.local'}}
13:50:56,482 INFO  com.cloudera.streaming.examples.flink.LogSink                 - HeapAlert{message='Full GC expected soon', triggeringStats=HeapStats{area=PS Old Gen, used=65709552, max=5726797824, ratio=0.011474047804625276, jobId=11, hostname='morhidi-mbp.local'}}
13:50:56,481 INFO  com.cloudera.streaming.examples.flink.LogSink                 - HeapAlert{message='Full GC expected soon', triggeringStats=HeapStats{area=PS Old Gen, used=65709552, max=5726797824, ratio=0.011474047804625276, jobId=10, hostname='morhidi-mbp.local'}}
```

LogSink is a custom sink implementation that simply sends the messages to the logging framework. The logs can be redirected via log4j to any centralized logging system or simply printed to the standard output when debugging. The quick start application provides a sample log4j config for redirecting the logs to a Kafka topic.

```
...
log4j.logger.com.cloudera=INFO, stdout, kafka
log4j.additivity.com.cloudera=false

log4j.appender.kafka=org.apache.kafka.log4jappender.KafkaLog4jAppender
log4j.appender.kafka.brokerList=flink-ref-1.gce.cloudera.com:9092,flink-ref-2.gce.cloudera.com:9092,flink-ref-3.gce.cloudera.com:9092
log4j.appender.kafka.topic=flink
log4j.appender.kafka.layout=org.apache.log4j.PatternLayout
log4j.appender.kafka.layout.ConversionPattern=%d{HH:mm:ss,SSS} %-5p %-60c %x - %m%n
...
```
The alerts thresholds are configurable via two program arguments that can be set to a low value for testing:

```
--warningThreshold 0.1
--criticalThreshold 0.2
```

## Running the compiled example on a remote Cluster

### Prerequisites

### B
```
git clone https://github.infra.cloudera.com/morhidi/flink-ref.git
cd flink-quickstart-cdh
mvn clean package
```
