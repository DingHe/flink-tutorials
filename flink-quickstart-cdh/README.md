# Flink Quickstart Application

The purpose of the Flink Quickstart Application is to have a working boilerplate code for a Flink project on top of CDH. The application demonstrates some basic capabilities of DataStream API available in Flink. It collects basic heap statistics of the JVM it's running on and stores the collected data on HDFS. In case the heap size is close to the maximum it triggers an alert message to the log. 

## Usage

```
git clone https://github.infra.cloudera.com/morhidi/flink-ref.git
```
## Importing the project to IntelliJ
The quickstart application is based on the public Flink maven archetype. The project can be imported into IntelliJ by following the instructions given at:
https://ci.apache.org/projects/flink/flink-docs-stable/dev/projectsetup/java_api_quickstart.html#maven

## Testing the project from IntelliJ

Simple run the class HeapMonitorPipeline from the IDE which should print something similar to the console:
```
...
13:50:54,524 INFO  com.cloudera.streaming.examples.flink.HeapMonitorSource       - starting HeapMonitorSource
13:50:54,524 INFO  com.cloudera.streaming.examples.flink.HeapMonitorSource       - starting HeapMonitorSource
13:50:54,524 INFO  com.cloudera.streaming.examples.flink.HeapMonitorSource       - starting HeapMonitorSource
13:50:54,524 INFO  com.cloudera.streaming.examples.flink.HeapMonitorSource       - starting HeapMonitorSource
...
```

The heap statistics are generated by a custom HeapMonitorSource class. All messages are saved to the file system. The output path is configurable with a program argument, e.g.:
```
--output <path>
```


The application triggers alerts when the old gen space of the executing container JVM exceeds certain threshold values. The heap alerts are sent to a special LogSink:

```
13:50:56,481 INFO  com.cloudera.streaming.examples.flink.LogSink                 - HeapAlert{message='Full GC expected soon', triggeringStats=HeapStats{area=PS Old Gen, used=65709552, max=5726797824, ratio=0.011474047804625276, jobId=3, hostname='morhidi-mbp.local'}}
13:50:56,482 INFO  com.cloudera.streaming.examples.flink.LogSink                 - HeapAlert{message='Full GC expected soon', triggeringStats=HeapStats{area=PS Old Gen, used=65709552, max=5726797824, ratio=0.011474047804625276, jobId=11, hostname='morhidi-mbp.local'}}
13:50:56,481 INFO  com.cloudera.streaming.examples.flink.LogSink                 - HeapAlert{message='Full GC expected soon', triggeringStats=HeapStats{area=PS Old Gen, used=65709552, max=5726797824, ratio=0.011474047804625276, jobId=10, hostname='morhidi-mbp.local'}}
```

LogSink is a custom sink implementation that simply prints the messages to the application logs. The application logs can be redirected via log4j to any centralized logging system or printed to the ouput for debugging. The quick start application provides a sample on how to redirect the logs into a Kafka topic.

```
...
log4j.logger.com.cloudera=INFO, stdout, kafka
log4j.additivity.com.cloudera=false

log4j.appender.kafka=org.apache.kafka.log4jappender.KafkaLog4jAppender
log4j.appender.kafka.brokerList=flink-ref-1.gce.cloudera.com:9092,flink-ref-2.gce.cloudera.com:9092,flink-ref-3.gce.cloudera.com:9092
log4j.appender.kafka.topic=flink
log4j.appender.kafka.layout=org.apache.log4j.PatternLayout
log4j.appender.kafka.layout.ConversionPattern=%d{HH:mm:ss,SSS} %-5p %-60c %x - %m%n
...
```
The threshold values are configurable via two parameters, e.g.:

```
--warningThreshold 0.8
--criticalThreshold 0.9
```

## Running the compiled example on a remote Cluster

### Prerequisites

### B
```
git clone https://github.infra.cloudera.com/morhidi/flink-ref.git
cd flink-quickstart-cdh
mvn clean package
```
